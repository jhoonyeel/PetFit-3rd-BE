name: Deploy BE (PetFit)

on:
  push:
    branches: ["main"]
    paths:
      - "**"
      - ".github/workflows/deploy.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Build
        run: npm run build

      - name: Prepare deploy payload
        run: |
          mkdir -p _deploy
          cp -r dist _deploy/dist
          cp package.json package-lock.json _deploy/

      - name: Upload to EC2 (rsync)
        uses: burnett01/rsync-deployments@7.0.2
        with:
          switches: -avzr --delete
          path: _deploy/
          remote_path: /var/www/petfit-be/releases/${{ github.run_id }}_${{ github.run_attempt }}/
          remote_host: ${{ secrets.EC2_HOST }}
          remote_user: ${{ secrets.EC2_USER }}
          remote_key: ${{ secrets.EC2_SSH_KEY }}

      - name: Activate release (atomic swap + npm ci + pm2 reload)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            RELEASE_DIR="/var/www/petfit-be/releases/${{ github.run_id }}_${{ github.run_attempt }}"
            /var/www/petfit-be/deploy.sh "$RELEASE_DIR"
